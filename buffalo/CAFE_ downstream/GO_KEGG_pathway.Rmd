---
title: "GO_KEGG_Reactome_pathway"
author: "Kelly Ren"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::html_document2: default
bibliography: FinalthesisRef.bib
link-citations: yes
fig_caption: yes
toc: yes
---

```{r}
#------------------------------------------------------
# Program name: GO_KEGG_pathway.Rmd
# Objective: This script collect the gene families from CAFE results and match for gene by using human as a representative, and do GO,KEGG and Reactome enrichment analysis.
# Author: Kelly Ren
# Email add: kellyDREN@gmail.com
#------------------------------------------------------
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r}
library(ggplot2)
library(easyGgplot2)
library(magrittr)
library(readr)
library(dplyr)
library(stringr)
library(tidyverse)
library(readxl)
library(gtools)
library(tibble)
library(reshape2)
library(limma)
library(ReactomePA)
library(clusterProfiler)
library(GenomicFeatures)

'%!in%' <- function(x,y)!('%in%'(x,y))
```

## human database
```{r}
ah <- read_rds("All_annotation.rds") 
ensDb <- ah[["AH83216"]]
ensDb
# Homo sapiens
```

```{r}
genesGR <- GenomicFeatures::genes(ensDb)
genesGR
```

```{r }
cols2Keep <- c("gene_id","gene_name", "gene_biotype", "description", "entrezid")
mcols(genesGR) <- mcols(genesGR)[, cols2Keep]

Genes <- genesGR%>%
  as.data.frame()
Genes$entrezid <- Genes$entrezid%>%as.character()
```


```{r}
human_ALL_entrezID <- genesGR %>% 
  subset(!is.na(entrezid)) %>%
  mcols() %>%
  .[["entrezid"]] %>%
  unlist() %>%
  unique() 
```

# results cafe all genes

```{r}
results_Gene_GL_PTHR <- read_csv("results_Gene_GL_PTHR.csv")%>%
  as.data.frame()
results_Gene_GL_PTHR$species%>%table()

results_Gene_GL_PTHR$PANTHER_ID%>%
  unique()%>%
  length()
```


```{r}
results_Gene_GL_PTHR <- results_Gene_GL_PTHR[,2:7]%>%
  subset(species %in% "Hsap")%>%
  unique()

colnames(results_Gene_GL_PTHR) <- colnames(results_Gene_GL_PTHR) %>%gsub("ToEntrez","entrezEntrez",.)
```

```{r}
results_Gene_GL_PTHR$entrezEntrez%>%
  unique()%>%
  length()

results_Gene_GL_PTHR$PANTHER_ID%>%
  unique()%>%
  length()

goRes <- goana(results_Gene_GL_PTHR$entrezEntrez, human_ALL_entrezID, species = "Hs")
```
#### GO
```{r}
human_goRes <- goRes%>%
  rownames_to_column("GO_ID")%>%
  mutate(fdr = p.adjust(P.DE, "fdr"))%>%
  subset(fdr < 0.01)%>%
  arrange(fdr)

human_goRes%>%
  dim()

subset(human_goRes, Ont %in% "BP")$GO_ID%>%
  as.data.frame()
```

#### KEGG
```{r  KEGG pathway}
keggRes <- kegga(results_Gene_GL_PTHR$ToEntrez, human_ALL_entrezID, species = "Hs") # for KEGG pathway

human_keggRes <- keggRes%>% 
  rownames_to_column("KEGG_ID")%>%
  mutate(fdr = p.adjust(P.DE, method = "fdr"))%>%
  subset(fdr < 0.01)%>%
  arrange(fdr)
human_keggRes
human_keggRes$KEGG_ID%>%
  gsub("path:hsa","hsa:",.)%>%
  as.data.frame()
```
# results cafe immune genes

### all immune genes
```{r}
results_Gene_GL_PTHR_immune <- read_csv("results_Gene_GL_PTHR_immune.csv")%>%
as.data.frame()%>%
  subset(species %in% "Hsap")

results_Gene_GL_PTHR_immune$Entrez_ID%>%
  unique()%>%
  length() #909 immune genes

results_Gene_GL_PTHR_immune$PANTHER_ID%>%
  unique()%>%
  length()

results_Gene_GL_PTHR_immune$Entrez_ID%>%
  unique()

```
#### GO
```{r}
goRes <- goana(results_Gene_GL_PTHR_immune$ToEntrez, results_Gene_GL_PTHR$ToEntrez, species = "Hs")

human_immune_goRes <- goRes%>%
  rownames_to_column("GO_ID")%>%
  mutate(fdr = p.adjust(P.DE, "fdr"))%>%
  subset(fdr < 0.01)%>%
  arrange(fdr)

human_immune_goRes%>%
  dim()

subset(human_immune_goRes, Ont %in% "BP")$GO_ID%>%
  as.data.frame()
```

#### KEGG
```{r  KEGG pathway}
keggRes <- kegga(results_Gene_GL_PTHR_immune$entrezEntrez, results_Gene_GL_PTHR$entrezEntrez, species = "Hs") # for KEGG pathway

human_immune_keggRes <- keggRes%>% 
  rownames_to_column("KEGG_ID")%>%
  mutate(fdr = p.adjust(P.DE, method = "fdr"))%>%
  subset(fdr < 0.01)%>%
  arrange(fdr)
human_immune_keggRes
human_immune_keggRes$KEGG_ID%>%
  gsub("path:hsa","hsa:",.)%>%
  as.data.frame()
```
#### Reactome

```{r}
geneList <- list(X1 = results_Gene_GL_PTHR$ToEntrez,
                 X2 = results_Gene_GL_PTHR_immune$ToEntrez)
Pathway_Cluster <- compareCluster(geneList, fun="enrichPathway", pAdjustMethod="fdr", qvalueCutoff=0.01)
GO_Cluster <- compareCluster(geneList, fun="enrichGO", pAdjustMethod="fdr", qvalueCutoff=0.01, OrgDb='org.Hs.eg.db')
summary(Pathway_Cluster)
summary(GO_Cluster)



plot <- cnetplot(Pathway_Cluster, node_label = 'category', colorEdge = T, categorySize="pvalue")
plot[[1]]$layers[[1]]$aes_params$size =10

cnetplot(Pathway_Cluster, node_label = 'category', colorEdge = T, categorySize="pvalue")

cnetplot(Pathway_Cluster, node_label = 'none', colorEdge = T, categorySize="pvalue")

```

```{r}
sigSite_enrichPath <- enrichPathway(gene=results_Gene_GL_PTHR$entrezEntrez, pAdjustMethod="fdr", qvalueCutoff=0.01, readable=T, minGSSize = 3, maxGSSize = 300)
cnetplot(sigSite_enrichPath, categorySize="pvalue", node_label = 'category')
```

```{r}
sigSite_enrichPath <- enrichPathway(gene=results_Gene_GL_PTHR_immune$entrezEntrez, pAdjustMethod="fdr", qvalueCutoff=0.01, readable=T, minGSSize = 3, maxGSSize = 300)
cnetplot(sigSite_enrichPath, categorySize="pvalue", node_label = 'category')
```

```{r}
sigSite_enrichPath <- enrichGO(gene=results_Gene_GL_PTHR$entrezEntrez, pAdjustMethod="fdr", qvalueCutoff=0.01, readable=T, minGSSize = 3, maxGSSize = 300, OrgDb='org.Hs.eg.db')

summary(sigSite_enrichPath)
cnetplot(sigSite_enrichPath, categorySize="pvalue", node_label = 'category')
```


# Appendix

```{r}
sessionInfo()
```
